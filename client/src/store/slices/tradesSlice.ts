import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import axios from 'axios';

const API_BASE = import.meta.env.VITE_API_URL || '';

export const fetchOpenTrades = createAsyncThunk('trades/fetchOpenTrades', async () => {
  const isLocal = import.meta.env.DEV;
  if (isLocal) {
    return [{"transaction_id":"f97184c4-b3e7-4231-82c5-093150ac14c2","ticker":"GOLDBEES","stock_id":"05199165-109b-4a92-ae56-7bb534159a51","type":"BUY","quantity":"45","price":"113.13","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"107a6800-d60e-4ee3-9b9e-9a492468f768","ticker":"SILVERBEES","stock_id":"8cbe24dc-a8f8-4f2c-a0d2-9e3b43edee62","type":"BUY","quantity":"22","price":"231.79","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"2e35492f-8947-4c14-ab12-96036cbf0544","ticker":"CPSEETF","stock_id":"e3132eb0-063e-454c-85b4-f37f5e69675d","type":"BUY","quantity":"53","price":"94.86","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"92e97175-c352-4cc0-8405-0b4f4de0e1b8","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"177","price":"28.35","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"8bfab09d-3ce8-49a5-bc0b-187978f977ec","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"88","price":"57.05","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"98120d00-0487-4538-9119-2613bad42839","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"224","price":"22.37","date":"2026-01-06T00:00:00.000Z","is_open":true},{"transaction_id":"9f45320e-da13-410a-81d7-18dd0e43affd","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"156","price":"32.2","date":"2026-01-05T00:00:00.000Z","is_open":true},{"transaction_id":"a1aced37-9e10-4d79-afd5-46ead1c7702c","ticker":"CPSEETF","stock_id":"e3132eb0-063e-454c-85b4-f37f5e69675d","type":"BUY","quantity":"53","price":"94.73","date":"2026-01-05T00:00:00.000Z","is_open":true},{"transaction_id":"5e87e4b9-2ebd-436e-be70-631e7fe81b38","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"331","price":"15.17","date":"2026-01-05T00:00:00.000Z","is_open":true},{"transaction_id":"c97a2134-e6f3-437b-b5bc-61d6feea57be","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"88","price":"56.9","date":"2026-01-02T00:00:00.000Z","is_open":true},{"transaction_id":"75c54824-baa5-4acb-a702-7acea267ea2d","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"87","price":"57.57","date":"2026-01-01T00:00:00.000Z","is_open":true},{"transaction_id":"ae08baf4-ee9a-4c49-9bb9-f66e06c12633","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"86","price":"58.19","date":"2026-01-01T00:00:00.000Z","is_open":true},{"transaction_id":"56a54f87-5925-480f-9987-2464e454b4c5","ticker":"GOLDBEES","stock_id":"05199165-109b-4a92-ae56-7bb534159a51","type":"BUY","quantity":"46","price":"110.87","date":"2025-12-30T00:00:00.000Z","is_open":true},{"transaction_id":"d256c246-93b6-4e74-b059-058c64ea474a","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"227","price":"22.08","date":"2025-12-30T00:00:00.000Z","is_open":true},{"transaction_id":"0216892f-1666-4cc0-8f2e-0d51975c3d6b","ticker":"GOLDBEES","stock_id":"05199165-109b-4a92-ae56-7bb534159a51","type":"BUY","quantity":"45","price":"112.9","date":"2025-12-29T00:00:00.000Z","is_open":true},{"transaction_id":"b7ec98e9-06db-4812-af7f-82e8e40d4c99","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"332","price":"15.09","date":"2025-12-29T00:00:00.000Z","is_open":true},{"transaction_id":"01d6aa81-d70d-4c7a-986c-c50088b76cda","ticker":"SILVERBEES","stock_id":"8cbe24dc-a8f8-4f2c-a0d2-9e3b43edee62","type":"BUY","quantity":"22","price":"235.95","date":"2025-12-29T00:00:00.000Z","is_open":true},{"transaction_id":"b3548428-ae39-4790-acd8-bd5f1a2e96ed","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"225","price":"22.27","date":"2025-12-26T00:00:00.000Z","is_open":true},{"transaction_id":"f616979a-303f-4d0b-b0de-be9e9766352a","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"330","price":"15.16","date":"2025-12-26T00:00:00.000Z","is_open":true},{"transaction_id":"c8125138-6432-469a-b39b-f9503dd47ae6","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"85","price":"59","date":"2025-12-24T00:00:00.000Z","is_open":true},{"transaction_id":"498de772-e22c-4077-91c1-ce66cb6cbd54","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"329","price":"15.2","date":"2025-12-23T00:00:00.000Z","is_open":true},{"transaction_id":"c9c014cf-e1a0-4e0d-8b10-a8a66d6d34c9","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"329","price":"15.21","date":"2025-12-23T00:00:00.000Z","is_open":true},{"transaction_id":"fe9b0e69-86e7-40eb-a9de-9c9dc1aba750","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"203","price":"59.91","date":"2025-11-11T00:00:00.000Z","is_open":true},{"transaction_id":"a257a5fb-8c0d-478d-8490-e408d782cf93","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"315","price":"59.91","date":"2025-10-24T00:00:00.000Z","is_open":true},{"transaction_id":"2ad010ca-03c1-44ed-a8e1-c9468c951ed2","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"9","price":"60.55","date":"2025-10-20T00:00:00.000Z","is_open":true},{"transaction_id":"0cad10f5-b1c0-4eb9-9a05-2340869752ad","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"11","price":"60.55","date":"2025-10-20T00:00:00.000Z","is_open":true},{"transaction_id":"d8ab051e-f65d-4ec8-9f0d-1392bec07e81","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"112","price":"58.24","date":"2025-10-03T00:00:00.000Z","is_open":true},{"transaction_id":"1fe09616-f39c-4f42-9b61-108cf48806fa","ticker":"FMCGIETF","stock_id":"df623ed1-586a-42d8-883b-e6b3c89ef2a0","type":"BUY","quantity":"111","price":"59.06","date":"2025-09-24T00:00:00.000Z","is_open":true},{"transaction_id":"b3a5d8c9-5fc7-4c18-b11c-fbeca95143d8","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"20","price":"25.87","date":"2025-07-01T00:00:00.000Z","is_open":true},{"transaction_id":"c93476f9-2aa5-4d71-8fe4-7ce2122060d9","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"230","price":"26.2","date":"2025-01-07T00:00:00.000Z","is_open":true},{"transaction_id":"3e023cf0-d77f-4115-bcdb-b3bf1fa1e5e1","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"220","price":"28.33","date":"2024-12-27T00:00:00.000Z","is_open":true},{"transaction_id":"9b6d3e9a-efc9-4af3-8de5-5c6c7ee427c2","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"180","price":"33.93","date":"2024-12-23T00:00:00.000Z","is_open":true},{"transaction_id":"fa6d3cea-4b42-459d-8d41-7421f4a89916","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"200","price":"28.86","date":"2024-12-17T00:00:00.000Z","is_open":true},{"transaction_id":"07609a97-b80a-4320-8681-6ca6c0c2e363","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"80","price":"27.1","date":"2024-12-12T00:00:00.000Z","is_open":true},{"transaction_id":"9834a596-2fe0-4e65-9184-e97ed06acd48","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"100","price":"29.13","date":"2024-12-10T00:00:00.000Z","is_open":true},{"transaction_id":"1a6801fd-b324-4382-bf9d-25e61ed3a62e","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"200","price":"15.69","date":"2024-12-06T00:00:00.000Z","is_open":true},{"transaction_id":"863f629a-0245-4e3a-ac17-3dadaedb75fa","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"100","price":"29.21","date":"2024-12-06T00:00:00.000Z","is_open":true},{"transaction_id":"2d1e989b-9b66-4221-84f0-e237391aeb7c","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"60","price":"34.99","date":"2024-11-08T00:00:00.000Z","is_open":true},{"transaction_id":"3a97276a-9ab2-4c78-b209-e7f75a3118be","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"35.65","date":"2024-11-07T00:00:00.000Z","is_open":true},{"transaction_id":"5b15787a-0aa5-4b92-be35-fb1f1789156c","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"80","price":"26.77","date":"2024-11-07T00:00:00.000Z","is_open":true},{"transaction_id":"80313cbf-06dd-4e93-8afb-9d556b4853c4","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"2","price":"29.15","date":"2024-10-29T00:00:00.000Z","is_open":true},{"transaction_id":"cd56e128-893a-4330-aa58-4a486dd2f151","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"35","price":"29.5","date":"2024-10-28T00:00:00.000Z","is_open":true},{"transaction_id":"52cc4ebb-ec9b-44d4-b054-a5fac18125db","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"36.23","date":"2024-10-22T00:00:00.000Z","is_open":true},{"transaction_id":"3d643223-7e63-4dd6-a319-92bc82333104","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"35","price":"29.91","date":"2024-10-22T00:00:00.000Z","is_open":true},{"transaction_id":"ff38e44a-03d3-4d06-ab4c-919fb6bd7cd9","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"36.88","date":"2024-10-21T00:00:00.000Z","is_open":true},{"transaction_id":"91e35038-7f48-4257-8462-99913f06bd56","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"65","price":"15.62","date":"2024-10-21T00:00:00.000Z","is_open":true},{"transaction_id":"0d19c035-a678-4874-81bb-50c31a7e325f","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"45","price":"22.95","date":"2024-10-18T00:00:00.000Z","is_open":true},{"transaction_id":"a6fb5958-f436-4f5a-84a5-3c4ad70a3867","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"45","price":"23.02","date":"2024-10-18T00:00:00.000Z","is_open":true},{"transaction_id":"7182dccd-7008-4cc9-bb20-2f1472c45a8a","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"40","price":"23.12","date":"2024-10-17T00:00:00.000Z","is_open":true},{"transaction_id":"bff478c8-56e2-4bff-a695-10f5d42f9074","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"35","price":"30.52","date":"2024-10-17T00:00:00.000Z","is_open":true},{"transaction_id":"79a7906b-41eb-4c97-81da-ca2babad8a1c","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"40","price":"28.32","date":"2024-10-17T00:00:00.000Z","is_open":true},{"transaction_id":"43f6ef8e-acac-476e-9538-3a30b5516abb","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"37.32","date":"2024-10-17T00:00:00.000Z","is_open":true},{"transaction_id":"a733ecc2-d255-41b5-a944-8230729dd8e1","ticker":"ALPL30IETF","stock_id":"ad2df9b0-6520-4648-946b-64029d5dd150","type":"BUY","quantity":"100","price":"31.09","date":"2024-10-15T00:00:00.000Z","is_open":true},{"transaction_id":"10796672-0a21-4a2f-a112-d707888f9d84","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"60","price":"15.8","date":"2024-10-08T00:00:00.000Z","is_open":true},{"transaction_id":"c4665dd1-7202-4dca-b021-00cac978b767","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"40","price":"23.09","date":"2024-10-08T00:00:00.000Z","is_open":true},{"transaction_id":"ea1d30e7-c903-47c1-9e66-1f2c7f1d53ac","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"36.42","date":"2024-10-07T00:00:00.000Z","is_open":true},{"transaction_id":"6f87ca74-fd7c-4667-b3a6-bb9fc2d9653a","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"50","price":"23.34","date":"2024-10-07T00:00:00.000Z","is_open":true},{"transaction_id":"8cff06d0-0bcd-4573-8000-dc8ac9e58047","ticker":"NIFTYQLITY","stock_id":"21b96dfd-270b-425e-a6d5-5cd42c11c098","type":"BUY","quantity":"150","price":"23.27","date":"2024-10-04T00:00:00.000Z","is_open":true},{"transaction_id":"1eee401a-c87e-41a0-86a0-ae805097af34","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"28","price":"37.42","date":"2024-10-04T00:00:00.000Z","is_open":true},{"transaction_id":"1eee6ef6-d799-445e-ac09-bd4b6899a34f","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"30","price":"37.97","date":"2024-10-03T00:00:00.000Z","is_open":true},{"transaction_id":"67e46a93-8aa6-41a8-80d2-38ae855ce7d5","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"35","price":"28.63","date":"2024-10-03T00:00:00.000Z","is_open":true},{"transaction_id":"03d51fe0-d723-4b32-9528-b71543c52bc9","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"65","price":"16.01","date":"2024-10-03T00:00:00.000Z","is_open":true},{"transaction_id":"824cb6e0-57cb-47a9-a610-60d29960d633","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"40","price":"28.95","date":"2024-09-30T00:00:00.000Z","is_open":true},{"transaction_id":"7976955a-c91f-4896-9661-a69726fae662","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"62","price":"16.18","date":"2024-09-30T00:00:00.000Z","is_open":true},{"transaction_id":"293910cf-d3a8-4148-b4b4-0e585237235c","ticker":"MOM30IETF","stock_id":"cd39da78-4a7a-47e2-ae2d-6920d692504b","type":"BUY","quantity":"80","price":"38","date":"2024-09-30T00:00:00.000Z","is_open":true},{"transaction_id":"b6c6f457-c986-4433-8dda-aa297c94f6f2","ticker":"NV20IETF","stock_id":"56def90f-ef0b-4df3-9a7e-2ceace902770","type":"BUY","quantity":"180","price":"16.11","date":"2024-09-16T00:00:00.000Z","is_open":true},{"transaction_id":"6f6167d1-d689-4438-b64c-de1e55f8d3bd","ticker":"ALPHAETF","stock_id":"3f4df3ed-ef90-4610-972a-aa4e9f62f8d7","type":"BUY","quantity":"170","price":"29.3","date":"2024-08-27T00:00:00.000Z","is_open":true},{"transaction_id":"cb3f6cb9-9ad0-4c23-a3eb-75e7fc12fea6","ticker":"CPSEETF","stock_id":"e3132eb0-063e-454c-85b4-f37f5e69675d","type":"BUY","quantity":"50","price":"103","date":"2024-08-13T00:00:00.000Z","is_open":true},{"transaction_id":"c99ebac8-da3c-4db8-96b5-97b5339efb2a","ticker":"CPSEETF","stock_id":"e3132eb0-063e-454c-85b4-f37f5e69675d","type":"BUY","quantity":"50","price":"104.7","date":"2024-08-02T00:00:00.000Z","is_open":true}]
  } else {
    const response = await axios.get(`${API_BASE}/api/openTransactions`);
    return response.data;
  }
});

export const fetchTradeById = createAsyncThunk(
  'trades/fetchById',
  async (id: string) => {
    const response = await axios.get(`${API_BASE}/api/transactions/${id}`);
    return response.data;
  }
);

const tradesSlice = createSlice({
  name: 'trades',
  initialState: { openTrades: [], status: 'idle' },
  reducers: {
    // Manually remove a lot after a successful SELL to keep UI snappy
    removeOpenTrade: (state, action) => {
      state.openTrades = state.openTrades.filter(t => t.transaction_id !== action.payload);
    }
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchOpenTrades.fulfilled, (state, action) => {
        state.openTrades = action.payload;
        state.status = 'succeeded';
      });
  },
});

export const { removeOpenTrade } = tradesSlice.actions;
export default tradesSlice.reducer;